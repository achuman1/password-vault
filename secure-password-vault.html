<!DOCTYPE html>
<html lang="en" class="h-full bg-gray-900">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secure Password Vault</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom scrollbar for vault list */
        .vault-list::-webkit-scrollbar {
            width: 8px;
        }
        .vault-list::-webkit-scrollbar-track {
            background: #1f2937; /* gray-800 */
        }
        .vault-list::-webkit-scrollbar-thumb {
            background: #4b5563; /* gray-600 */
            border-radius: 4px;
        }
        .vault-list::-webkit-scrollbar-thumb:hover {
            background: #6b7280; /* gray-500 */
        }
        /* Hide password input text */
        .password-display {
            -webkit-text-security: disc;
            text-security: disc;
        }
    </style>
</head>
<body class="h-full flex items-center justify-center bg-gray-900 text-white p-4">

    <div class="w-full max-w-4xl h-[700px] max-h-[90vh] bg-gray-800 rounded-lg shadow-2xl flex overflow-hidden">

        <div id="loading-view" class="w-full flex flex-col items-center justify-center p-8">
            <svg class="animate-spin h-10 w-10 text-indigo-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p class="mt-4 text-gray-400 text-lg">Initializing Secure Vault...</p>
        </div>

        <div id="auth-view" class="w-full hidden flex-col items-center justify-center p-8 md:p-12">
            <div class="w-full max-w-md">
                <svg class="h-12 w-auto text-indigo-400 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M16.5 10.5V6.75a4.5 4.5 0 00-9 0v3.75m-.75 11.25h10.5a2.25 2.25 0 002.25-2.25v-6.75a2.25 2.25 0 00-2.25-2.25H6.75a2.25 2.25 0 00-2.25 2.25v6.75a2.25 2.25 0 002.25 2.25z" />
                </svg>
                <h2 class="mt-6 text-center text-3xl font-bold tracking-tight text-white">Secure Password Vault</h2>
                <p class="mt-2 text-center text-sm text-gray-400">
                    Your zero-knowledge password manager.
                </p>

                <form id="auth-form" class="mt-8 space-y-6">
                    <input type="hidden" name="remember" value="true">
                    <div class="rounded-md shadow-sm -space-y-px">
                        <div>
                            <label for="auth-email" class="sr-only">Email address</label>
                            <input id="auth-email" name="email" type="email" autocomplete="email" required class="relative block w-full appearance-none rounded-t-md border border-gray-700 bg-gray-900 px-3 py-3 text-white placeholder-gray-500 focus:z-10 focus:border-indigo-500 focus:outline-none focus:ring-indigo-500 sm:text-sm" placeholder="Email address">
                        </div>
                        <div>
                            <label for="auth-password" class="sr-only">Master Password</label>
                            <input id="auth-password" name="password" type="password" autocomplete="current-password" required class="relative block w-full appearance-none rounded-b-md border border-gray-700 bg-gray-900 px-3 py-3 text-white placeholder-gray-500 focus:z-10 focus:border-indigo-500 focus:outline-none focus:ring-indigo-500 sm:text-sm" placeholder="Master Password">
                        </div>
                    </div>

                    <div id="auth-error" class="text-red-400 text-sm hidden text-center"></div>

                    <div class="flex flex-col sm:flex-row sm:space-x-4 space-y-4 sm:space-y-0">
                        <button type="submit" id="login-button" class="group relative flex w-full justify-center rounded-md border border-transparent bg-indigo-600 py-3 px-4 text-sm font-medium text-white hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 focus:ring-offset-gray-800">
                            Log In
                        </button>
                        <button type="submit" id="signup-button" class="group relative flex w-full justify-center rounded-md border border-indigo-600 py-3 px-4 text-sm font-medium text-indigo-400 hover:bg-indigo-900/30 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 focus:ring-offset-gray-800">
                            Sign Up
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <div id="vault-view" class="w-full hidden md:flex h-full">
            <div class="w-full md:w-1/3 bg-gray-800 p-6 border-r border-gray-700 flex flex-col">
                <h2 class="text-2xl font-semibold text-white">Add New Credential</h2>
                <form id="add-password-form" class="mt-6 space-y-4 flex-grow">
                    <div>
                        <label for="site-name" class="block text-sm font-medium text-gray-300">Website / Service</label>
                        <input type="text" id="site-name" required class="mt-1 block w-full rounded-md border-gray-700 bg-gray-900 text-white shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm py-2.5 px-3">
                    </div>
                    <div>
                        <label for="site-username" class="block text-sm font-medium text-gray-300">Username / Email</label>
                        <input type="text" id="site-username" required class="mt-1 block w-full rounded-md border-gray-700 bg-gray-900 text-white shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm py-2.5 px-3">
                    </div>
                    <div>
                        <label for="site-password" class="block text-sm font-medium text-gray-300">Password</label>
                        <input type="password" id="site-password" required class="mt-1 block w-full rounded-md border-gray-700 bg-gray-900 text-white shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm py-2.5 px-3">
                    </div>
                    <div class="pt-2">
                        <button type="submit" class="w-full flex justify-center rounded-md border border-transparent bg-indigo-600 py-2.5 px-4 text-sm font-medium text-white shadow-sm hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 focus:ring-offset-gray-800">
                            Add to Vault
                        </button>
                    </div>
                </form>
                
                <div class="mt-6 border-t border-gray-700 pt-4">
                     <p class="text-sm text-gray-400">User ID: <span id="user-id" class="font-mono text-xs"></span></p>
                    <button id="logout-button" class="mt-4 w-full flex justify-center items-center rounded-md border border-gray-700 py-2.5 px-4 text-sm font-medium text-gray-300 shadow-sm hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 focus:ring-offset-gray-800">
                        <svg class="h-5 w-5 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 9V5.25A2.25 2.25 0 0013.5 3h-6a2.25 2.25 0 00-2.25 2.25v13.5A2.25 2.25 0 007.5 21h6a2.25 2.25 0 002.25-2.25V15M12 9l-3 3m0 0l3 3m-3-3h12.75" />
                        </svg>
                        Log Out
                    </button>
                </div>
            </div>

            <div class="w-full md:w-2/3 bg-gray-900 flex flex-col">
                <div class="p-6 border-b border-gray-700">
                    <h1 class="text-3xl font-semibold text-white">Your Vault</h1>
                </div>
                <div id="vault-list-container" class="vault-list flex-grow overflow-y-auto p-6">
                    <div id="empty-vault-message" class="text-center text-gray-500 pt-10">
                        <svg class="h-12 w-12 mx-auto text-gray-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M16.5 10.5V6.75a4.5 4.5 0 00-9 0v3.75m-.75 11.25h10.5a2.25 2.25 0 002.25-2.25v-6.75a2.25 2.25 0 00-2.25-2.25H6.75a2.25 2.25 0 00-2.25 2.25v6.75a2.25 2.25 0 002.25 2.25z" />
                        </svg>
                        <p class="mt-4 text-lg">Your vault is empty.</p>
                        <p class="text-sm">Add a new credential using the form on the left.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="error-toast" class="hidden fixed bottom-5 right-5 bg-red-600 text-white py-3 px-5 rounded-lg shadow-lg z-50">
        <span id="error-toast-message"></span>
    </div>

    <div id="copy-toast" class="hidden fixed bottom-5 right-5 bg-green-600 text-white py-3 px-5 rounded-lg shadow-lg z-50">
        Password copied to clipboard!
    </div>

    <script type="module">
        // Firebase SDK Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            onAuthStateChanged,
            createUserWithEmailAndPassword,
            signInWithEmailAndPassword,
            signOut,
            setPersistence,
            browserSessionPersistence // Store auth state in session
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            getDoc, 
            setDoc,
            updateDoc,
            setLogLevel
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        //import { initializeApp } from "firebase/app";
        // TODO: Add SDKs for Firebase products that you want to use
        // https://firebase.google.com/docs/web/setup#available-libraries

        // Your web app's Firebase configuration
        const firebaseConfig = {
        apiKey: "AIzaSyBkiCWL6AVkHqHcBX1vi-sOIO_S7Z757n8",
        authDomain: "secret-vault-52e19.firebaseapp.com",
        projectId: "secret-vault-52e19",
        storageBucket: "secret-vault-52e19.firebasestorage.app",
        messagingSenderId: "245532305847",
        appId: "1:245532305847:web:e72fac18468e2aa9fea032"
        };

        // Initialize Firebase
        //const app = initializeApp(firebaseConfig);
        
        // --- THIS LINE WAS REMOVED ---
        // const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';


        let app, auth, db;
        let currentEncryptionKey = null; // Stores the derived CryptoKey
        let currentDecryptedVault = null; // Stores the decrypted vault object
        let currentUserId = null;
        let vaultDocRef = null;

        // --- UI Elements ---
        const views = {
            loading: document.getElementById('loading-view'),
            auth: document.getElementById('auth-view'),
            vault: document.getElementById('vault-view'),
        };
        const authForm = document.getElementById('auth-form');
        const loginButton = document.getElementById('login-button');
        const signupButton = document.getElementById('signup-button');
        const logoutButton = document.getElementById('logout-button');
        const addPasswordForm = document.getElementById('add-password-form');
        const vaultListContainer = document.getElementById('vault-list-container');
        const emptyVaultMessage = document.getElementById('empty-vault-message');
        const authEmailInput = document.getElementById('auth-email');
        const authPasswordInput = document.getElementById('auth-password');
        const errorToast = document.getElementById('error-toast');
        const errorToastMessage = document.getElementById('error-toast-message');
        const copyToast = document.getElementById('copy-toast');
        const userIdSpan = document.getElementById('user-id');

        // --- UI Helper Functions ---
        
        /**
         * Shows a specific view and hides all others
         * @param {string} viewId - 'loading', 'auth', or 'vault'
         */
        function showView(viewId) {
            Object.values(views).forEach(view => view.classList.add('hidden'));
            if (views[viewId]) {
                views[viewId].classList.remove('hidden');
            }
        }

        /**
         * Displays an error message to the user
         * @param {string} message - The error message to display
         * @param {string} type - 'auth' (in-form) or 'toast' (global)
         */
        function showError(message, type = 'toast') {
            console.error(message);
            if (type === 'auth') {
                const authErrorEl = document.getElementById('auth-error');
                authErrorEl.textContent = message;
                authErrorEl.classList.remove('hidden');
            } else {
                errorToastMessage.textContent = message;
                errorToast.classList.remove('hidden');
                setTimeout(() => {
                    errorToast.classList.add('hidden');
                }, 3000);
            }
        }

        /**
         * Shows a success toast for copying
         */
        function showCopySuccess() {
            copyToast.classList.remove('hidden');
            setTimeout(() => {
                copyToast.classList.add('hidden');
            }, 2000);
        }

        /**
         * Renders the currentDecryptedVault into the DOM
         */
        function renderVault() {
            // Clear existing list
            vaultListContainer.innerHTML = '';
            
            if (!currentDecryptedVault || Object.keys(currentDecryptedVault).length === 0) {
                vaultListContainer.appendChild(emptyVaultMessage);
                emptyVaultMessage.classList.remove('hidden');
                return;
            }

            emptyVaultMessage.classList.add('hidden');
            
            // Sort entries by site name
            const sortedSites = Object.keys(currentDecryptedVault).sort((a, b) => a.localeCompare(b));

            for (const site of sortedSites) {
                const entry = currentDecryptedVault[site];
                const entryEl = document.createElement('div');
                entryEl.className = 'bg-gray-800 p-4 rounded-lg shadow-md mb-4 flex items-center';
                entryEl.innerHTML = `
                    <div class="flex-grow">
                        <h3 class="text-lg font-semibold text-indigo-300">${escapeHTML(site)}</h3>
                        <p class="text-sm text-gray-400">${escapeHTML(entry.username)}</p>
                        <p class="text-sm text-gray-400 font-mono password-display">${escapeHTML(entry.password)}</p>
                    </div>
                    <button data-password="${escapeHTML(entry.password)}" class="copy-password-button ml-4 p-2 rounded-md bg-gray-700 text-gray-300 hover:bg-indigo-600 hover:text-white transition-colors">
                        <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M15.666 3.888A2.25 2.25 0 0013.5 2.25h-3c-1.03 0-1.9.693-2.166 1.638m7.332 0c.055.196.084.4.084.612v0a2.25 2.25 0 01-2.25 2.25H9A2.25 2.25 0 016.75 4.5v0c0-.212.03-.416.084-.612m7.332 0c.646.049 1.288.11 1.927.184 1.1.128 1.907 1.077 1.907 2.185V19.5a2.25 2.25 0 01-2.25 2.25H6.75A2.25 2.25 0 014.5 19.5V6.257c0-1.108.806-2.057 1.907-2.185a48.208 48.208 0 011.927-.184" />
                        </svg>
                    </button>
                    <button data-site="${escapeHTML(site)}" class="delete-password-button ml-2 p-2 rounded-md bg-gray-700 text-gray-300 hover:bg-red-600 hover:text-white transition-colors">
                        <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                           <path stroke-linecap="round" stroke-linejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12.5 0c-.31_0_-.623.012-.925.034M13.5 3.75l-1.5-1.5-1.5 1.5" />
                        </svg>
                    </button>
                `;
                vaultListContainer.appendChild(entryEl);
            }
            
            // Add event listeners to new buttons
            vaultListContainer.querySelectorAll('.copy-password-button').forEach(btn => {
                btn.addEventListener('click', () => {
                    copyToClipboard(btn.dataset.password);
                    showCopySuccess();
                });
            });
            vaultListContainer.querySelectorAll('.delete-password-button').forEach(btn => {
                btn.addEventListener('click', () => {
                    handleDeletePassword(btn.dataset.site);
                });
            });
        }
        
        /**
         * Copies text to the clipboard
         * @param {string} text - Text to copy
         */
        function copyToClipboard(text) {
            const ta = document.createElement('textarea');
            ta.value = text;
            document.body.appendChild(ta);
            ta.select();
            try {
                // Use execCommand as a fallback for iFrame context
                document.execCommand('copy');
            } catch (err) {
                console.error('Failed to copy text: ', err);
                showError('Failed to copy text.');
            }
            document.body.removeChild(ta);
        }

        /**
         * Escapes HTML to prevent XSS
         * @param {string} str - String to escape
         */
        function escapeHTML(str) {
            return str.replace(/[&<>"']/g, function(m) {
                return {
                    '&': '&amp;',
                    '<': '&lt;',
                    '>': '&gt;',
                    '"': '&quot;',
                    "'": '&#039;'
                }[m];
            });
        }


        // --- Crypto Helper Functions ---
        // Using window.crypto.subtle for all operations
        
        const textEncoder = new TextEncoder();
        const textDecoder = new TextDecoder();
        const PBKDF2_ITERATIONS = 100000;

        /**
         * Converts an ArrayBuffer to a Base64 string
         * @param {ArrayBuffer} buffer - The buffer to encode
         * @returns {string} - Base64 string
         */
        function arrayBufferToB64(buffer) {
            let binary = '';
            const bytes = new Uint8Array(buffer);
            const len = bytes.byteLength;
            for (let i = 0; i < len; i++) {
                binary += String.fromCharCode(bytes[i]);
            }
            return window.btoa(binary);
        }

        /**
         * Converts a Base64 string to an ArrayBuffer
         * @param {string} b64 - The Base64 string
         * @returns {ArrayBuffer} - Decoded ArrayBuffer
         */
        function b64ToArrayBuffer(b64) {
            const binary_string = window.atob(b64);
            const len = binary_string.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binary_string.charCodeAt(i);
            }
            return bytes.buffer;
        }

        /**
         * Derives an AES-GCM 256-bit key from a password and salt using PBKDF2
         * @param {string} password - The user's master password
         * @param {Uint8Array} salt - The KDF salt
         * @returns {Promise<CryptoKey>} - The derived encryption key
         */
        async function deriveKey(password, salt) {
            const keyMaterial = await window.crypto.subtle.importKey(
                "raw",
                textEncoder.encode(password),
                "PBKDF2",
                false,
                ["deriveKey"]
            );
            return window.crypto.subtle.deriveKey(
                {
                    name: "PBKDF2",
                    salt: salt,
                    iterations: PBKDF2_ITERATIONS,
                    hash: "SHA-256"
                },
                keyMaterial,
                { name: "AES-GCM", length: 256 },
                true,
                ["encrypt", "decrypt"]
            );
        }

        /**
         * Encrypts data with AES-GCM
         * @param {string} data - Plaintext data to encrypt
         * @param {CryptoKey} key - The encryption key from deriveKey()
         * @returns {Promise<{ciphertext: ArrayBuffer, iv: Uint8Array}>}
         */
        async function encrypt(data, key) {
            const iv = window.crypto.getRandomValues(new Uint8Array(12)); // 96-bit IV
            const ciphertext = await window.crypto.subtle.encrypt(
                {
                    name: "AES-GCM",
                    iv: iv
                },
                key,
                textEncoder.encode(data)
            );
            return { ciphertext, iv };
        }

        /**
         * Decrypts data with AES-GCM
         * @param {ArrayBuffer} ciphertext - Ciphertext to decrypt
         * @param {CryptoKey} key - The encryption key from deriveKey()
         * @param {Uint8Array} iv - The IV used during encryption
         * @returns {Promise<string>} - Decrypted plaintext
         */
        async function decrypt(ciphertext, key, iv) {
            try {
                const decryptedBuffer = await window.crypto.subtle.decrypt(
                    {
                        name: "AES-GCM",
                        iv: iv
                    },
                    key,
                    ciphertext
                );
                return textDecoder.decode(decryptedBuffer);
            } catch (e) {
                console.error("Decryption failed:", e);
                // This almost always means the password (and thus the key) was wrong.
                throw new Error("Decryption failed. Invalid master password.");
            }
        }

        // --- Firebase/App Logic Functions ---

        /**
         * Handles the Sign Up process
         */
        async function handleSignUp(email, password) {
            try {
                // 1. Create user in Firebase Auth
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;
                currentUserId = user.uid;
                
                // --- THIS LINE IS FIXED ---
                vaultDocRef = doc(db, "users", currentUserId, "vault", "data");
                
                userIdSpan.textContent = currentUserId;

                // 2. Generate a new salt
                const salt = window.crypto.getRandomValues(new Uint8Array(16));
                
                // 3. Derive the encryption key
                currentEncryptionKey = await deriveKey(password, salt);

                // 4. Create and encrypt an empty vault
                currentDecryptedVault = {};
                const { ciphertext, iv } = await encrypt(JSON.stringify(currentDecryptedVault), currentEncryptionKey);

                // 5. Store the salt and the encrypted empty vault in Firestore
                await setDoc(vaultDocRef, {
                    kdf_salt: arrayBufferToB64(salt),
                    encrypted_vault: arrayBufferToB64(ciphertext),
                    iv: arrayBufferToB64(iv)
                });

                // 6. Show the vault view
                renderVault();
                showView('vault');

            } catch (error) {
                showError(error.message, 'auth');
            }
        }

        /**
         * Handles the Log In process
         */
        async function handleLogIn(email, password) {
            try {
                // 1. Sign in with Firebase Auth
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;
                currentUserId = user.uid;
                
                // --- THIS LINE IS FIXED ---
                vaultDocRef = doc(db, "users", currentUserId, "vault", "data");
                
                userIdSpan.textContent = currentUserId;

                // 2. Fetch the vault document from Firestore
                const docSnap = await getDoc(vaultDocRef);
                if (!docSnap.exists()) {
                    // This case might happen if signup was interrupted.
                    // For this app, we'll treat it as a fresh signup.
                    console.warn("Vault doc not found for user. Creating a new one.");
                    return await handleSignUp(email, password);
                }
                
                const vaultData = docSnap.data();
                const salt = b64ToArrayBuffer(vaultData.kdf_salt);
                const iv = b64ToArrayBuffer(vaultData.iv);
                const ciphertext = b64ToArrayBuffer(vaultData.encrypted_vault);

                // 3. Derive the encryption key
                currentEncryptionKey = await deriveKey(password, salt);

                // 4. Decrypt the vault
                const vaultJson = await decrypt(ciphertext, currentEncryptionKey, iv);
                currentDecryptedVault = JSON.parse(vaultJson);

                // 5. Show the vault
                renderVault();
                showView('vault');

            } catch (error) {
                showError(error.message, 'auth');
            }
        }

        /**
         * Handles adding a new password entry
         */
        async function handleAddPassword(site, username, password) {
            if (!currentEncryptionKey || currentDecryptedVault === null) {
                showError("Vault is locked or not initialized.");
                return;
            }
            
            if (currentDecryptedVault[site]) {
                // Simple merge: just overwrite.
                // A real app would ask to confirm overwrite.
                console.log(`Entry for ${site} already exists. Overwriting.`);
            }

            // 1. Add to in-memory vault
            currentDecryptedVault[site] = { username, password };

            try {
                // 2. Re-encrypt the *entire* vault with a new IV
                const { ciphertext, iv } = await encrypt(JSON.stringify(currentDecryptedVault), currentEncryptionKey);

                // 3. Update Firestore doc
                await updateDoc(vaultDocRef, {
                    encrypted_vault: arrayBufferToB64(ciphertext),
                    iv: arrayBufferToB64(iv)
                });
                
                // 4. Re-render the UI
                renderVault();
                addPasswordForm.reset();

            } catch (error) {
                showError(`Failed to save to vault: ${error.message}`);
                // Roll back in-memory change
                delete currentDecryptedVault[site];
            }
        }

        /**
         * Handles deleting a password entry
         */
        async function handleDeletePassword(site) {
             if (!currentEncryptionKey || currentDecryptedVault === null || !currentDecryptedVault[site]) {
                showError("Entry not found or vault is locked.");
                return;
            }
            
            // 0. Store old data for rollback
            const oldEntry = currentDecryptedVault[site];

            // 1. Delete from in-memory vault
            delete currentDecryptedVault[site];

            try {
                // 2. Re-encrypt the *entire* vault with a new IV
                const { ciphertext, iv } = await encrypt(JSON.stringify(currentDecryptedVault), currentEncryptionKey);

                // 3. Update Firestore doc
                await updateDoc(vaultDocRef, {
                    encrypted_vault: arrayBufferToB64(ciphertext),
                    iv: arrayBufferToB64(iv)
                });
                
                // 4. Re-render the UI
                renderVault();

            } catch (error) {
                showError(`Failed to delete entry: ${error.message}`);
                // Roll back in-memory change
                currentDecryptedVault[site] = oldEntry;
            }
        }


        /**
         * Handles the Log Out process
         */
        async function handleLogOut() {
            try {
                await signOut(auth);
                // Auth state listener (onAuthStateChanged) will handle the rest
            } catch (error) {
                showError(error.message);
            }
        }


        // --- App Initialization ---
        function main() {
            if (!firebaseConfig || Object.keys(firebaseConfig).length === 0) {
                showView('auth'); // Show auth view
                showError("Firebase config is missing. App cannot load.", 'auth');
                return;
            }
            
            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                setLogLevel('Debug'); // Enable Firestore logging

                // Use session persistence: user stays logged in for the session
                setPersistence(auth, browserSessionPersistence)
                    .then(() => {
                        // Set up the auth state listener
                        setupAuthListener();
                    })
                    .catch((error) => {
                        showError(`Failed to set auth persistence: ${error.message}`, 'auth');
                        setupAuthListener(); // Continue anyway
                    });

            } catch (e) {
                console.error("Firebase init failed:", e);
                showView('auth');
                showError("Failed to initialize app.", 'auth');
            }
        }
        
        function setupAuthListener() {
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    // User is signed in, but vault is still locked.
                    // We need to re-login to get the password and decrypt.
                    // For this demo, we assume the user just logged in.
                    // A real app would show an "Unlock" screen.
                    
                    // This state is handled by the login/signup functions
                    // which transition to the 'vault' view.
                    // If the user reloads, they will be logged in, but
                    // we have no password to derive the key.
                    // The simplest "secure" flow is to log them out.
                    
                    if (!currentEncryptionKey) {
                        // User is logged in but we don't have the key
                        // (e.g., page refresh).
                        // Force logout to require re-entry of password.
                        console.log("User authenticated but key is missing. Forcing logout for re-authentication.");
                        await handleLogOut();
                    } else {
                        // Key exists, user is logged in. Show vault.
                        currentUserId = user.uid;

                        // --- THIS LINE IS FIXED ---
                        vaultDocRef = doc(db, "users", currentUserId, "vault", "data");
                        
                        userIdSpan.textContent = currentUserId;
                        renderVault();
                        showView('vault');
                    }
                    
                } else {
                    // User is signed out
                    currentEncryptionKey = null;
                    currentDecryptedVault = null;
                    currentUserId = null;
                    vaultDocRef = null;
                    authForm.reset();
                    showView('auth');
                }
            });
        }

        // --- Event Listeners ---
        
        loginButton.addEventListener('click', (e) => {
            e.preventDefault();
            document.getElementById('auth-error').classList.add('hidden');
            const email = authEmailInput.value;
            const password = authPasswordInput.value;
            if (!email || !password) {
                showError("Email and password are required.", 'auth');
                return;
            }
            showView('loading');
            handleLogIn(email, password);
        });
        
        signupButton.addEventListener('click', (e) => {
            e.preventDefault();
            document.getElementById('auth-error').classList.add('hidden');
            const email = authEmailInput.value;
            const password = authPasswordInput.value;
            if (!email || !password) {
                showError("Email and password are required.", 'auth');
                return;
            }
            if (password.length < 6) {
                showError("Password must be at least 6 characters.", 'auth');
                return;
            }
            showView('loading');
            handleSignUp(email, password);
        });
        
        logoutButton.addEventListener('click', (e) => {
            e.preventDefault();
            handleLogOut();
        });

        addPasswordForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const site = document.getElementById('site-name').value;
            const username = document.getElementById('site-username').value;
            const password = document.getElementById('site-password').value;
            if (!site || !username || !password) {
                showError("All fields are required.");
                return;
            }
            handleAddPassword(site, username, password);
        });

        // Start the app
        main();

    </script>
</body>
</html>
